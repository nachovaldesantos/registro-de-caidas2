// URL de la API de SheetDB
const apiUrl = "https://sheetdb.io/api/v1/oawmv4fq268tr";

// Función para obtener datos desde la API
async function fetchDataFromSheetDB() {
    try {
        const response = await fetch(apiUrl);
        const sheetData = await response.json();
        const apiData = sheetData.map(item => ({
            id: generateUniqueId(),
            residente: item["Nombre del residente"] || "Desconocido",
            fecha: item.Fecha || "",
            franja: item["Franja horaria"] || "",
            lugar: item.Lugar || "",
            consecuencias: item.Consecuencias || "",
            sensor: item["Sensor de Movimiento"] || ""
        }));
        // Combinar los datos locales con los de la API
        data = [...data, ...apiData];
        // Actualizar la interfaz
        renderTable(data);
        updateChart();
        updateCounters(data);
        alert("Datos sincronizados con éxito desde SheetDB.");
    } catch (error) {
        console.error("Error al obtener datos de SheetDB:", error);
        alert("No se pudieron sincronizar los datos desde SheetDB.");
    }
}

// Función para enviar nuevos datos a la API
async function sendDataToSheetDB(newData) {
    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                "Nombre del residente": newData.residente,
                Fecha: newData.fecha,
                "Franja horaria": newData.franja,
                Lugar: newData.lugar,
                Consecuencias: newData.consecuencias,
                "Sensor de Movimiento": newData.sensor
            })
        });
        if (response.ok) {
            alert("Nuevo registro añadido correctamente a SheetDB.");
        } else {
            console.error("Error al enviar datos:", response.statusText);
            alert("Hubo un problema al registrar los datos en SheetDB.");
        }
    } catch (error) {
        console.error("Error al enviar datos a SheetDB:", error);
        alert("Error al comunicarse con SheetDB.");
    }
}

// Llamada inicial para sincronizar los datos
fetchDataFromSheetDB();

// Modificación del evento de registro para sincronizar con SheetDB
document.getElementById("registroCaidas").addEventListener("submit", async function (e) {
    e.preventDefault();
    // Capturar datos del formulario como en tu lógica actual
    const newEntry = {
        residente: document.getElementById("nombreResidente").value.trim(),
        fecha: parseFecha(document.getElementById("fechaCaida").value),
        franja: franjaSelect.value,
        lugar: lugarSelect.value,
        consecuencias: consecuenciasSelect.value,
        sensor: sensorSelect.value
    };

    // Validación y normalización como en tu código
    if (!newEntry.residente || !newEntry.fecha || !newEntry.franja || !newEntry.lugar || !newEntry.consecuencias || !newEntry.sensor) {
        alert("Por favor, completa todos los campos.");
        return;
    }

    // Agregar al array local
    newEntry.id = generateUniqueId();
    data.push(newEntry);
    renderTable(data);
    updateChart();
    updateCounters(data);

    // Enviar datos a SheetDB
    await sendDataToSheetDB(newEntry);
});
