<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Caídas de Residentes Mejorado</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #343a40;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .chart-container {
            margin: 20px 0;
            max-width: 100%;
        }
        canvas {
            max-height: 400px;
            background-color: white; /* Fondo blanco para el canvas */
        }
        .chart-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header class="bg-primary text-white text-center py-4">
        <h1>Registro de Caídas de Residentes</h1>
    </header>
    <main class="container my-4">
        <!-- Selector de Gráficas -->
        <div class="card">
            <div class="card-header">
                <h5>Selecciona el Tipo de Gráfica</h5>
            </div>
            <div class="card-body chart-selector">
                <button class="btn btn-outline-primary me-2" id="btnFranja">Franja Horaria</button>
                <button class="btn btn-outline-primary me-2" id="btnLugar">Lugar</button>
                <button class="btn btn-outline-primary me-2" id="btnConsecuencias">Consecuencias</button>
                <button class="btn btn-outline-primary me-2" id="btnLugarHabitacion">Lugar dentro de la habitación</button> <!-- Nuevo Botón -->
                <button class="btn btn-outline-primary" id="btnResidente">Residente con 3+ Caídas</button> <!-- Nuevo Botón -->
            </div>
        </div>

        <!-- Gráfica y Botón de Descarga -->
        <div class="card">
            <div class="card-header">
                <h5>Visualización de Datos</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="chart"></canvas>
                </div>
                <div class="text-center">
                    <button id="downloadChart" class="btn btn-secondary mt-3">Descargar Gráfica</button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card">
            <div class="card-header">
                <h5>Filtros</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="filterFranjaSelect" class="form-label">Filtrar por franja horaria:</label>
                        <select id="filterFranjaSelect" class="form-select">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterLugarSelect" class="form-label">Filtrar por lugar:</label>
                        <select id="filterLugarSelect" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterConsecuenciasSelect" class="form-label">Filtrar por consecuencias:</label>
                        <select id="filterConsecuenciasSelect" class="form-select">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterResidenteSelect" class="form-label">Filtrar por residente:</label>
                        <select id="filterResidenteSelect" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones y Exportaciones -->
        <div class="card">
            <div class="card-header">
                <h5>Acciones</h5>
            </div>
            <div class="card-body text-end">
                <button id="exportExcel" class="btn btn-success me-2">Exportar a Excel</button>
                <!-- Nuevo Botón para Importar desde Excel -->
                <button id="importExcelBtn" class="btn btn-info me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Formato de fecha esperado: d/m/yyyy o yyyy-mm-dd">Importar desde Excel</button>
                <!-- Input de Archivo Oculto -->
                <input type="file" id="importExcelInput" accept=".xlsx, .xls" style="display: none;">
                <button id="deleteAll" class="btn btn-danger me-2">Eliminar Todos los Registros</button>
                <button id="undoAction" class="btn btn-warning" disabled>Deshacer Última Acción</button>
                <!-- Nota sobre el Formato de Fecha -->
                <div class="mt-2">
                    <small class="text-muted">Formatos de fecha esperados: <strong>d/m/yyyy</strong> o <strong>yyyy-mm-dd</strong></small>
                </div>
            </div>
        </div>

        <!-- Contadores de Caídas -->
        <div class="card">
            <div class="card-header">
                <h5>Contadores de Caídas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Total de Caídas Registradas: <span id="totalFalls">0</span></h6>
                    </div>
                    <div class="col-md-6">
                        <h6>Caídas Visibles: <span id="visibleFalls">0</span></h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Datos -->
        <div class="card">
            <div class="card-header">
                <h5>Registro de Caídas</h5>
            </div>
            <div class="card-body table-container">
                <table class="table table-striped" id="data-table">
                    <thead>
                        <tr>
                            <th>Nombre del residente</th>
                            <th>Fecha</th>
                            <th>Franja horaria</th>
                            <th>Lugar de la caída</th>
                            <th>Consecuencias</th>
                            <th>Sensor de movimiento</th>
                            <th>Acciones</th> <!-- Nueva columna para acciones -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas generadas por JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Formulario de Registro de Caídas -->
        <div class="card">
            <div class="card-header">
                <h5>Registrar Nueva Caída</h5>
            </div>
            <div class="card-body">
                <form id="registroCaidas">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="nombreResidente" class="form-label">Nombre del Residente</label>
                            <input type="text" class="form-control" id="nombreResidente" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fechaCaida" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fechaCaida" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="franjaHoraria" class="form-label">Franja Horaria</label>
                            <select class="form-select" id="franjaHoraria" required>
                                <option value="">Selecciona una opción</option>
                                <option value="0 a 2">0 a 2</option>
                                <option value="2 a 4">2 a 4</option>
                                <option value="4 a 6">4 a 6</option>
                                <option value="6 a 8">6 a 8</option>
                                <option value="8 a 10">8 a 10</option>
                                <option value="10 a 12">10 a 12</option>
                                <option value="12 a 14">12 a 14</option>
                                <option value="14 a 16">14 a 16</option>
                                <option value="16 a 18">16 a 18</option>
                                <option value="18 a 20">18 a 20</option>
                                <option value="20 a 22">20 a 22</option>
                                <option value="22 a 0">22 a 0</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="lugarCaida" class="form-label">Lugar</label>
                            <select class="form-select" id="lugarCaida" required>
                                <option value="">Selecciona una opción</option>
                                <option value="Al lado de la cama de la habitación">Al lado de la cama de la habitación</option>
                                <option value="A los pies de la cama de la habitación">A los pies de la cama de la habitación</option>
                                <option value="En mitad de la habitación">En mitad de la habitación</option>
                                <option value="Puerta del baño de la habitación">Puerta del baño de la habitación</option>
                                <option value="Dentro del baño de la habitación">Dentro del baño de la habitación</option>
                                <option value="Pasillo">Pasillo</option>
                                <option value="Salón de la planta primera">Salón de la planta primera</option>
                                <option value="Salón de la planta segunda">Salón de la planta segunda</option>
                                <option value="Recepción">Recepción</option>
                                <option value="Comedor">Comedor</option>
                                <option value="Capilla">Capilla</option>
                                <option value="Sala de actividades">Sala de actividades</option>
                                <option value="Dentro del ascensor">Dentro del ascensor</option>
                                <option value="Terraza">Terraza</option>
                                <option value="Jardín">Jardín</option>
                                <option value="Salón fondo planta 1">Salón fondo planta 1</option>
                                <option value="Salón fondo planta 2">Salón fondo planta 2</option>
                                <option value="Sala común planta 3">Sala común planta 3</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="consecuencias" class="form-label">Consecuencias</label>
                            <select class="form-select" id="consecuencias" required>
                                <option value="">Selecciona una opción</option>
                                <option value="Sin consecuencias">Sin consecuencias</option>
                                <option value="Herida">Herida</option>
                                <option value="Contusión">Contusión</option>
                                <option value="TCE">TCE</option>
                                <option value="Fractura">Fractura</option>
                                <option value="Fractura cadera">Fractura cadera</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="sensorMovimiento" class="form-label">Sensor de Movimiento</label>
                            <select class="form-select" id="sensorMovimiento" required>
                                <option value="">Selecciona una opción</option>
                                <option value="Desconocido">Desconocido</option>
                                <option value="Se oyó">Se oyó</option>
                                <option value="No se oyó">No se oyó</option>
                                <option value="No hay sensor">No hay sensor</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">Registrar Caída</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS Bundle (Incluye Popper para Tooltips) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para generar IDs únicos
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para parsear fechas en formato "d/m/yyyy" o "yyyy-mm-dd"
        function parseFecha(fechaStr) {
            let partes;
            if (fechaStr.includes('/')) {
                partes = fechaStr.split('/');
                if (partes.length !== 3) return null;
                let [dia, mes, año] = partes;
                dia = parseInt(dia, 10);
                mes = parseInt(mes, 10);
                año = parseInt(año, 10);
                if (isNaN(dia) || isNaN(mes) || isNaN(año)) return null;
                // Validar que el día y el mes sean válidos
                if (dia < 1 || dia > 31 || mes < 1 || mes > 12) return null;
                return `${dia}/${mes}/${año}`;
            } else if (fechaStr.includes('-')) {
                partes = fechaStr.split('-');
                if (partes.length !== 3) return null;
                let [año, mes, dia] = partes;
                dia = parseInt(dia, 10);
                mes = parseInt(mes, 10);
                año = parseInt(año, 10);
                if (isNaN(dia) || isNaN(mes) || isNaN(año)) return null;
                // Validar que el día y el mes sean válidos
                if (dia < 1 || dia > 31 || mes < 1 || mes > 12) return null;
                return `${dia}/${mes}/${año}`;
            } else {
                return null;
            }
        }

        // Definir una paleta de colores
        const colorPalette = [
            'rgba(255, 99, 132, 0.6)',    // Rojo
            'rgba(54, 162, 235, 0.6)',    // Azul
            'rgba(255, 206, 86, 0.6)',    // Amarillo
            'rgba(75, 192, 192, 0.6)',    // Verde
            'rgba(153, 102, 255, 0.6)',   // Púrpura
            'rgba(255, 159, 64, 0.6)',    // Naranja
            'rgba(199, 199, 199, 0.6)',   // Gris
            'rgba(83, 102, 255, 0.6)',    // Azul oscuro
            'rgba(255, 102, 255, 0.6)',   // Rosa
            'rgba(102, 255, 102, 0.6)',   // Verde claro
            'rgba(255, 102, 102, 0.6)',   // Rojo claro
            'rgba(102, 255, 255, 0.6)'    // Cian
        ];

        // Función para asignar colores basados en las etiquetas
        function assignColors(labels) {
            const colors = [];
            for (let i = 0; i < labels.length; i++) {
                colors.push(colorPalette[i % colorPalette.length]);
            }
            return colors;
        }

        // Plugin para establecer el fondo blanco en el área de la gráfica
        const whiteBackgroundPlugin = {
            id: 'custom_canvas_background_color',
            beforeDraw: (chart, args, options) => {
                const {ctx, width, height} = chart;
                ctx.save();
                ctx.fillStyle = 'white'; // Color de fondo
                ctx.fillRect(0, 0, width, height);
                ctx.restore();
            }
        };

        // Registrar el plugin
        Chart.register(whiteBackgroundPlugin);

        // Función para ordenar los datos de mayor a menor
        function sortDataDescending(labels, counts, colors) {
            const combined = labels.map((label, index) => ({ label, count: counts[index], color: colors[index] }));
            combined.sort((a, b) => b.count - a.count);
            return {
                labels: combined.map(item => item.label),
                counts: combined.map(item => item.count),
                colors: combined.map(item => item.color)
            };
        }

        // Datos completos actualizados con IDs únicos y nombres de residentes normalizados
        let data = [
            { id: generateUniqueId(), residente: "Elías Lara", fecha: "4/5/2024", franja: "6 a 8", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "María Folgado", fecha: "13/5/2024", franja: "14 a 16", lugar: "En mitad de la habitación", consecuencias: "TCE", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "21/5/2024", franja: "16 a 18", lugar: "Al lado de la cama de la habitación", consecuencias: "Herida", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Mercedes Reguera", fecha: "14/5/2024", franja: "10 a 12", lugar: "Salón de la primera planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Luis Rodríguez", fecha: "2/7/2024", franja: "2 a 4", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "María Pérez", fecha: "23/5/2024", franja: "8 a 10", lugar: "Dentro del baño de la habitación", consecuencias: "TCE", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Luisa Cruz", fecha: "24/5/2024", franja: "18 a 20", lugar: "Terraza", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Francisco Ferreira", fecha: "4/6/2024", franja: "22 a 00", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Mercedes Reguera", fecha: "5/7/2024", franja: "4 a 6", lugar: "Dentro del baño de la habitación", consecuencias: "Fractura costal", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "María Mateos", fecha: "9/7/2024", franja: "8 a 10", lugar: "Dentro del baño de la habitación", consecuencias: "Fractura de muñeca", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "María Sancho", fecha: "16/7/2024", franja: "2 a 4", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "María Sancho", fecha: "19/7/2024", franja: "0 a 2", lugar: "Al lado de la cama de la habitación", consecuencias: "Contusión", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Martín Nieto", fecha: "21/7/2024", franja: "12 a 14", lugar: "Dentro del baño de la habitación", consecuencias: "Herida", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Cayo Martín", fecha: "22/7/2024", franja: "0 a 2", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Lucrecia García", fecha: "24/7/2024", franja: "0 a 2", lugar: "Pasillo", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Valentín Vera", fecha: "25/7/2024", franja: "16 a 18", lugar: "Salón de la planta segunda", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "31/7/2024", franja: "16 a 18", lugar: "Dentro del baño geriátrico", consecuencias: "Contusión", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "2/8/2024", franja: "2 a 4", lugar: "Dentro del baño de la habitación", consecuencias: "Contusión", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Mariano Iglesias", fecha: "16/8/2024", franja: "14 a 16", lugar: "Dentro del baño geriátrico", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Agustín Peinado", fecha: "23/8/2024", franja: "4 a 6", lugar: "Al lado de la cama de la habitación", consecuencias: "TCE", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Elías Lara", fecha: "27/8/2024", franja: "18 a 20", lugar: "A los pies de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Josefina Perdiguero", fecha: "27/8/2024", franja: "20 a 22", lugar: "A los pies de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "11/9/2024", franja: "16 a 18", lugar: "Recepción", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "María Sancho", fecha: "21/9/2024", franja: "20 a 22", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Elías Lara", fecha: "22/9/2024", franja: "12 a 14", lugar: "Comedor", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "23/9/2024", franja: "10 a 12", lugar: "Dentro del ascensor", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Luis Rodríguez", fecha: "26/9/2024", franja: "2 a 4", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Luciano González", fecha: "26/9/2024", franja: "20 a 22", lugar: "En mitad de la habitación", consecuencias: "Herida", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Mariano Iglesias", fecha: "28/9/2024", franja: "14 a 16", lugar: "Dentro del baño geriátrico", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "1/10/2024", franja: "20 a 22", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "4/10/2024", franja: "22 a 00", lugar: "Puerta del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "9/10/2024", franja: "22 a 00", lugar: "Puerta del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "10/10/2024", franja: "0 a 2", lugar: "En mitad de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Luciano González", fecha: "13/10/2024", franja: "20 a 22", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "13/10/2024", franja: "22 a 00", lugar: "En mitad de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "17/10/2024", franja: "20 a 22", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "17/10/2024", franja: "6 a 8", lugar: "Salón de la primera planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Ascensión Sáiz", fecha: "17/10/2024", franja: "10 a 12", lugar: "Salón de la segunda planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "18/10/2024", franja: "8 a 10", lugar: "Puerta del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Elías Lara", fecha: "18/10/2024", franja: "10 a 12", lugar: "Salón de la segunda planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "19/10/2024", franja: "22 a 00", lugar: "A los pies de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Agustín Peinado", fecha: "19/10/2024", franja: "6 a 8", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Luciano González", fecha: "19/10/2024", franja: "20 a 22", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "19/10/2024", franja: "8 a 10", lugar: "En mitad de la habitación", consecuencias: "Sin consecuencias", sensor: "Desconocido" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "19/10/2024", franja: "10 a 12", lugar: "Salón de la segunda planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "20/10/2024", franja: "16 a 18", lugar: "Pasillo", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "21/10/2024", franja: "4 a 6", lugar: "Puerta del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Mercedes Reguera", fecha: "21/10/2024", franja: "0 a 2", lugar: "Salón de la primera planta", consecuencias: "Contusión", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Juan Victorio Calvo", fecha: "26/10/2024", franja: "4 a 6", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Andrea Gutierrez", fecha: "26/10/2024", franja: "8 a 10", lugar: "Puerta del baño de la habitación", consecuencias: "Contusión", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Vicente Martínez", fecha: "27/10/2024", franja: "14 a 16", lugar: "Recepción", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Agustín Peinado", fecha: "2/11/2024", franja: "22 a 00", lugar: "Pasillo", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "3/11/2024", franja: "4 a 6", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Lucrecia García", fecha: "3/11/2024", franja: "16 a 18", lugar: "Sala de actividades", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Antonio del Valle", fecha: "4/11/2024", franja: "22 a 00", lugar: "Dentro del baño de la habitación", consecuencias: "Contusión", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "María Sancho", fecha: "7/11/2024", franja: "2 a 4", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Alberto González", fecha: "7/11/2024", franja: "16 a 18", lugar: "Planta primera", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Martín Nieto", fecha: "9/11/2024", franja: "14 a 16", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Martín Nieto", fecha: "10/11/2024", franja: "14 a 16", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Francisca Blanco", fecha: "13/11/2024", franja: "10 a 12", lugar: "Dentro del baño de la habitación", consecuencias: "Herida", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Manuela Vicente", fecha: "17/11/2024", franja: "14 a 16", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Alfredo Palazuelos", fecha: "21/11/2024", franja: "10 a 12", lugar: "Recepción", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Martín Nieto", fecha: "22/11/2024", franja: "16 a 18", lugar: "Salón de la segunda planta", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Mercedes Reguera", fecha: "28/11/2024", franja: "22 a 00", lugar: "A los pies de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            { id: generateUniqueId(), residente: "Elías Lara", fecha: "1/12/2024", franja: "8 a 10", lugar: "A los pies de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "Se oyó" },
            
            // **Nuevos Registros Añadidos:**
            { id: generateUniqueId(), residente: "Carmen Yela", fecha: "14/5/2024", franja: "10 a 12", lugar: "Al lado de la cama de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Isabel Sanz", fecha: "5/6/2024", franja: "16 a 18", lugar: "Dentro del baño de la habitación", consecuencias: "Herida", sensor: "No hay sensor" },
            { id: generateUniqueId(), residente: "Josefina Perdiguero", fecha: "21/6/2024", franja: "16 a 18", lugar: "Dentro del baño de la habitación", consecuencias: "Sin consecuencias", sensor: "No hay sensor" }
        ];

        // Selectores de Filtros
        const filterFranjaSelect = document.getElementById('filterFranjaSelect');
        const filterLugarSelect = document.getElementById('filterLugarSelect');
        const filterConsecuenciasSelect = document.getElementById('filterConsecuenciasSelect'); // Nuevo Filtro
        const filterResidenteSelect = document.getElementById('filterResidenteSelect'); // Nuevo Filtro

        // Selectores del Formulario de Registro
        const franjaSelect = document.getElementById('franjaHoraria');
        const lugarSelect = document.getElementById('lugarCaida');
        const consecuenciasSelect = document.getElementById('consecuencias');
        const sensorSelect = document.getElementById('sensorMovimiento');

        const tbody = document.querySelector("#data-table tbody");
        const ctx = document.getElementById('chart').getContext('2d');

        // Elementos para mostrar los contadores
        const totalFallsElement = document.getElementById('totalFalls');
        const visibleFallsElement = document.getElementById('visibleFalls');

        // Pila para gestionar acciones (para deshacer)
        let actionStack = [];

        // Variables para gestionar el tipo de gráfica actual
        let currentChartType = 'franja'; // Valores posibles: 'franja', 'lugar', 'consecuencias', 'lugarHabitacion', 'residente'

        // Renderizar tabla
        function renderTable(filteredData) {
            tbody.innerHTML = "";
            filteredData.forEach(item => {
                const row = `<tr>
                    <td>${item.residente}</td>
                    <td>${item.fecha}</td>
                    <td>${item.franja}</td>
                    <td>${item.lugar}</td>
                    <td>${item.consecuencias}</td>
                    <td>${item.sensor}</td>
                    <td><button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">Eliminar</button></td> <!-- Botón de eliminar -->
                </tr>`;
                tbody.innerHTML += row;
            });
            updateCounters(filteredData); // Actualizar los contadores después de renderizar la tabla
        }

        // Filtrar datos
        function filterData() {
            const selectedFranja = filterFranjaSelect.value;
            const selectedLugar = filterLugarSelect.value;
            const selectedConsecuencias = filterConsecuenciasSelect.value; // Nuevo Filtro
            const selectedResidente = filterResidenteSelect.value; // Nuevo Filtro

            const filtered = data.filter(item => {
                return (
                    (selectedFranja === "" || item.franja === selectedFranja) &&
                    (selectedLugar === "" || item.lugar === selectedLugar) &&
                    (selectedConsecuencias === "" || item.consecuencias === selectedConsecuencias) &&
                    (selectedResidente === "" || item.residente === selectedResidente)
                );
            });
            renderTable(filtered);
            updateChart();
        }

        // Inicializar selectores de Filtros
        function initializeFilterSelects() {
            const uniqueFranjas = [...new Set(data.map(d => d.franja))].sort((a, b) => {
                const timeOrder = ["0 a 2", "2 a 4", "4 a 6", "6 a 8", "8 a 10", "10 a 12", "12 a 14", "14 a 16", "16 a 18", "18 a 20", "20 a 22", "22 a 0"];
                return timeOrder.indexOf(a) - timeOrder.indexOf(b);
            });
            const uniqueLugares = [...new Set(data.map(d => d.lugar))].sort();
            const uniqueConsecuencias = [...new Set(data.map(d => d.consecuencias))].sort();
            const uniqueResidentes = [...new Set(data.map(d => d.residente))].sort();
            
            uniqueFranjas.forEach(f => {
                if (f !== '') {
                    filterFranjaSelect.innerHTML += `<option value="${f}">${f}</option>`;
                }
            });

            uniqueLugares.forEach(l => {
                if (l !== '') {
                    filterLugarSelect.innerHTML += `<option value="${l}">${l}</option>`;
                }
            });

            uniqueConsecuencias.forEach(c => {
                if (c !== '') {
                    filterConsecuenciasSelect.innerHTML += `<option value="${c}">${c}</option>`;
                }
            });

            uniqueResidentes.forEach(r => {
                if (r !== '') {
                    filterResidenteSelect.innerHTML += `<option value="${r}">${r}</option>`;
                }
            });
        }

        // Inicializar selectores del Formulario de Registro
        function initializeFormSelects() {
            // Los selectores del formulario ya tienen opciones fijas definidas en el HTML.
            // Esta función puede estar vacía o usarse para otros propósitos si se requiere.
        }

        // Funciones para obtener datos agregados
        function getCaidasPorFranja() {
            const franjaCount = {};
            data.forEach(item => {
                franjaCount[item.franja] = (franjaCount[item.franja] || 0) + 1;
            });
            // Ordenar según el orden de las franjas
            const timeOrder = ["0 a 2", "2 a 4", "4 a 6", "6 a 8", "8 a 10", "10 a 12", "12 a 14", "14 a 16", "16 a 18", "18 a 20", "20 a 22", "22 a 0"];
            const labels = timeOrder.filter(franja => franjaCount[franja]);
            const counts = labels.map(franja => franjaCount[franja]);
            const colors = assignColors(labels);
            return { labels, counts, colors };
        }

        function getCaidasPorLugar() {
            const lugarCount = {};
            data.forEach(item => {
                lugarCount[item.lugar] = (lugarCount[item.lugar] || 0) + 1;
            });
            let labels = Object.keys(lugarCount).sort();
            let counts = labels.map(lugar => lugarCount[lugar]);
            let colors = assignColors(labels);
            const sorted = sortDataDescending(labels, counts, colors);
            return sorted;
        }

        function getCaidasPorConsecuencias() {
            const consecuenciasCount = {};
            data.forEach(item => {
                consecuenciasCount[item.consecuencias] = (consecuenciasCount[item.consecuencias] || 0) + 1;
            });
            let labels = Object.keys(consecuenciasCount).sort();
            let counts = labels.map(consecuencia => consecuenciasCount[consecuencia]);
            let colors = assignColors(labels);
            const sorted = sortDataDescending(labels, counts, colors);
            return sorted;
        }

        // **Nueva Función para Caídas por Lugar dentro de la Habitación**
        function getCaidasPorLugarHabitacion() {
            const lugarHabitacionCount = {};
            data.forEach(item => {
                if (item.lugar.toLowerCase().includes("habitación")) {
                    // Normalizar para eliminar acentos
                    let lugarNormalized = item.lugar.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    // Extraer la parte específica del lugar dentro de la habitación
                    // Por ejemplo, "al lado de la cama de la habitacion" -> "Al lado de la cama"
                    let lugarEspecifico = lugarNormalized.replace(/al lado de la cama de la habitacion|a los pies de la cama de la habitacion|en mitad de la habitacion|puerta del baño de la habitacion|dentro del baño de la habitacion/g, match => {
                        switch(match) {
                            case "al lado de la cama de la habitacion": return "Al lado de la cama";
                            case "a los pies de la cama de la habitacion": return "A los pies de la cama";
                            case "en mitad de la habitacion": return "En mitad de la habitación";
                            case "puerta del baño de la habitacion": return "Puerta del baño";
                            case "dentro del baño de la habitacion": return "Dentro del baño";
                            default: return match;
                        }
                    });
                    // Capitalizar la primera letra
                    lugarEspecifico = lugarEspecifico.charAt(0).toUpperCase() + lugarEspecifico.slice(1);
                    // Contar
                    lugarHabitacionCount[lugarEspecifico] = (lugarHabitacionCount[lugarEspecifico] || 0) + 1;
                }
            });
            let labels = Object.keys(lugarHabitacionCount).sort();
            let counts = labels.map(lugar => lugarHabitacionCount[lugar]);
            let colors = assignColors(labels);
            const sorted = sortDataDescending(labels, counts, colors);
            return sorted;
        }

        // **Nueva Función para Caídas por Residente (3 o más caídas)**
        function getCaidasPorResidenteMin3() {
            const residenteCount = {};
            data.forEach(item => {
                residenteCount[item.residente] = (residenteCount[item.residente] || 0) + 1;
            });

            // Filtrar residentes con 3 o más caídas
            const filteredResidentes = Object.keys(residenteCount).filter(residente => residenteCount[residente] >= 3);
            
            // Crear un nuevo objeto con solo los residentes filtrados
            const residenteCountFiltered = {};
            filteredResidentes.forEach(residente => {
                residenteCountFiltered[residente] = residenteCount[residente];
            });

            let labels = Object.keys(residenteCountFiltered).sort();
            let counts = labels.map(residente => residenteCountFiltered[residente]);
            let colors = assignColors(labels);
            const sorted = sortDataDescending(labels, counts, colors);
            return sorted;
        }

        // Registrar el plugin ChartDataLabels
        Chart.register(ChartDataLabels);

        // Renderizar gráfica
        function renderChart(type) {
            let chartData;
            let chartLabel;
            if (type === 'franja') {
                chartData = getCaidasPorFranja();
                chartLabel = 'Número de caídas por franja horaria';
            } else if (type === 'lugar') {
                chartData = getCaidasPorLugar();
                chartLabel = 'Número de caídas por lugar';
            } else if (type === 'consecuencias') {
                chartData = getCaidasPorConsecuencias();
                chartLabel = 'Número de caídas por consecuencias';
            } else if (type === 'lugarHabitacion') { // Nuevo Tipo de Gráfica
                chartData = getCaidasPorLugarHabitacion();
                chartLabel = 'Número de caídas por lugar dentro de la habitación';
            } else if (type === 'residente') { // Nuevo Tipo de Gráfica
                chartData = getCaidasPorResidenteMin3();
                chartLabel = 'Número de caídas por residente (3 o más caídas)';
            }

            chart.data.labels = chartData.labels;
            chart.data.datasets[0].data = chartData.counts;
            chart.data.datasets[0].backgroundColor = chartData.colors;
            chart.data.datasets[0].borderColor = chartData.colors.map(color => color.replace('0.6', '1')); // Aumentar opacidad para bordes
            chart.data.datasets[0].label = chartLabel;
            chart.options.plugins.title.text = chartLabel;
            chart.update();
        }

        // Inicializar gráfico
        let chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [], // Se actualizará en renderChart
                datasets: [{
                    label: 'Número de caídas por franja horaria',
                    data: [],
                    backgroundColor: [], // Se actualizará dinámicamente
                    borderColor: [],     // Se actualizará dinámicamente
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false // Aquí se desactiva la leyenda
                    },
                    title: {
                        display: true,
                        text: 'Número de caídas por franja horaria'
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: function(value) {
                            return value;
                        },
                        font: {
                            weight: 'bold'
                        },
                        color: '#000'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        precision:0
                    }
                }
            },
            plugins: [ChartDataLabels, whiteBackgroundPlugin] // Añadir los plugins aquí
        });

        // Función para actualizar el gráfico según el tipo
        function updateChart() {
            renderChart(currentChartType);
        }

        // Función para actualizar los contadores
        function updateCounters(filteredData = data) {
            // Contador total
            const total = data.length;
            totalFallsElement.innerText = total;

            // Contador visible
            const visible = filteredData.length;
            visibleFallsElement.innerText = visible;
        }

        // Eventos de filtro
        filterFranjaSelect.addEventListener('change', filterData);
        filterLugarSelect.addEventListener('change', filterData);
        filterConsecuenciasSelect.addEventListener('change', filterData); // Nuevo Evento
        filterResidenteSelect.addEventListener('change', filterData); // Nuevo Evento

        // Exportar a Excel
        document.getElementById('exportExcel').addEventListener('click', () => {
            if (data.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            // Crear una copia de los datos sin la propiedad 'id' para evitar exportarla
            const exportData = data.map(({id, ...rest}) => rest);
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Datos");
            XLSX.writeFile(workbook, "RegistroCaidas.xlsx");
        });

        // Botón para Eliminar Todos los Registros
        document.getElementById('deleteAll').addEventListener('click', () => {
            if (data.length === 0) {
                alert('No hay registros para eliminar.');
                return;
            }
            if (confirm('¿Estás seguro de que deseas eliminar **todos** los registros? Esta acción no se puede deshacer.')) {
                // Guardar los registros actuales en la pila para deshacer
                actionStack.push({ action: 'deleteAll', records: [...data] });
                // Limpiar los datos
                data = [];
                // Re-renderizar tabla y gráfico
                renderTable(data);
                updateChart();
                // Actualizar estado de los botones
                updateButtonStates();
                alert('Todos los registros han sido eliminados.');
            }
        });

        // Botón para Deshacer la Última Acción
        document.getElementById('undoAction').addEventListener('click', () => {
            if (actionStack.length === 0) {
                alert('No hay acciones para deshacer.');
                return;
            }

            const lastAction = actionStack.pop();

            if (lastAction.action === 'add') {
                // Deshacer una adición eliminando el registro
                const index = data.findIndex(item => item.id === lastAction.record.id);
                if (index !== -1) {
                    data.splice(index, 1);
                }
            } else if (lastAction.action === 'delete') {
                // Deshacer una eliminación añadiendo el registro de vuelta
                data.push(lastAction.record);
            } else if (lastAction.action === 'deleteAll') {
                // Deshacer una eliminación de todos los registros añadiéndolos de vuelta
                data = lastAction.records;
            }

            // Re-renderizar tabla y gráfico
            filterData(); // Filtra y renderiza la tabla con los datos actualizados
            updateChart();

            // Actualizar estado de los botones
            updateButtonStates();

            alert('Última acción deshecha exitosamente.');
        });

        // Registro de nueva caída
        document.getElementById('registroCaidas').addEventListener('submit', function(e) {
            e.preventDefault();

            // Obtener valores del formulario
            let residente = document.getElementById('nombreResidente').value.trim();
            let fecha = document.getElementById('fechaCaida').value;
            let franja = franjaSelect.value;
            let lugar = lugarSelect.value;
            let consecuencias = consecuenciasSelect.value;
            let sensor = sensorSelect.value;

            // Validar que todos los campos estén llenos
            if (!residente || !fecha || !franja || !lugar || !consecuencias || !sensor) {
                alert('Por favor, completa todos los campos del formulario.');
                return;
            }

            // Normalizar el nombre del residente (eliminar tildes y convertir a mayúsculas iniciales)
            residente = residente.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\b\w/g, c => c.toUpperCase());

            // Validar fecha en formato "d/m/yyyy" o "yyyy-mm-dd"
            const fechaFormateada = parseFecha(fecha);
            if (!fechaFormateada) {
                alert('Por favor, ingresa una fecha válida en formato d/m/yyyy o yyyy-mm-dd.');
                return;
            }

            // Crear nuevo registro con un ID único
            const nuevoRegistro = {
                id: generateUniqueId(),
                residente: residente,
                fecha: fechaFormateada,
                franja: franja,
                lugar: lugar,
                consecuencias: consecuencias,
                sensor: sensor
            };

            // Agregar al array de datos
            data.push(nuevoRegistro);

            // Registrar la acción para deshacer
            actionStack.push({ action: 'add', record: nuevoRegistro });

            // Re-renderizar tabla y gráfico
            filterData(); // Filtra y renderiza la tabla con los datos actualizados
            updateChart();

            // Resetear formulario
            this.reset();

            // Actualizar estado de los botones
            updateButtonStates();

            // Actualizar filtros de residente si es un nuevo residente
            if (!filterResidenteSelect.querySelector(`option[value="${nuevoRegistro.residente}"]`)) {
                filterResidenteSelect.innerHTML += `<option value="${nuevoRegistro.residente}">${nuevoRegistro.residente}</option>`;
            }

            // Mostrar mensaje de confirmación
            alert('Caída registrada exitosamente');
        });

        // Evento para eliminar registros utilizando event delegation
        tbody.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const id = e.target.getAttribute('data-id');
                // Confirmación antes de eliminar
                if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
                    // Encontrar el índice del registro con el ID correspondiente
                    const index = data.findIndex(item => item.id === id);
                    if (index !== -1) {
                        // Guardar el registro en la pila para deshacer
                        const deletedRecord = data[index];
                        actionStack.push({ action: 'delete', record: deletedRecord });
                        // Eliminar el registro del array
                        data.splice(index, 1);
                        // Re-renderizar tabla y gráfico
                        filterData(); // Filtra y renderiza la tabla con los datos actualizados
                        updateChart();
                        // Actualizar estado de los botones
                        updateButtonStates();
                        alert('Registro eliminado exitosamente');
                    }
                }
            }
        });

        // Eventos para los botones de selección de gráficas
        document.getElementById('btnFranja').addEventListener('click', function() {
            currentChartType = 'franja';
            setActiveButton(this);
            updateChart();
        });

        document.getElementById('btnLugar').addEventListener('click', function() {
            currentChartType = 'lugar';
            setActiveButton(this);
            updateChart();
        });

        document.getElementById('btnConsecuencias').addEventListener('click', function() {
            currentChartType = 'consecuencias';
            setActiveButton(this);
            updateChart();
        });

        document.getElementById('btnLugarHabitacion').addEventListener('click', function() { // Nuevo Evento
            currentChartType = 'lugarHabitacion';
            setActiveButton(this);
            updateChart();
        });

        document.getElementById('btnResidente').addEventListener('click', function() { // Nuevo Evento
            currentChartType = 'residente';
            setActiveButton(this);
            updateChart();
        });

        // Función para resaltar el botón activo
        function setActiveButton(button) {
            const buttons = document.querySelectorAll('.chart-selector .btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        // Función para actualizar el estado de los botones
        function updateButtonStates() {
            const undoButton = document.getElementById('undoAction');
            const deleteAllButton = document.getElementById('deleteAll');

            // Actualizar botón de deshacer
            if (actionStack.length > 0) {
                undoButton.disabled = false;
            } else {
                undoButton.disabled = true;
            }

            // Actualizar botón de eliminar todos
            if (data.length > 0) {
                deleteAllButton.disabled = false;
            } else {
                deleteAllButton.disabled = true;
            }
        }

        // Función para descargar la gráfica como imagen PNG de alta calidad
        function downloadChartAsImage() {
            try {
                const link = document.createElement('a');
                link.href = chart.toBase64Image('image/png', 1); // Formato PNG y calidad máxima
                link.download = `grafica_${currentChartType}_${new Date().toISOString().slice(0,10)}.png`; // Nombre del archivo con extensión .png
                link.click();
                // Opcional: Mostrar un mensaje de confirmación
                alert('La gráfica ha sido descargada exitosamente en formato PNG.');
            } catch (error) {
                console.error('Error al descargar la gráfica:', error);
                alert('Hubo un error al intentar descargar la gráfica. Por favor, inténtalo de nuevo.');
            }
        }

        // Añadir evento al botón de descarga
        document.getElementById('downloadChart').addEventListener('click', downloadChartAsImage);

        // Inicializar todo al cargar la página
        window.onload = function() {
            initializeFilterSelects();
            initializeFormSelects();
            // Inicializar el gráfico primero
            renderChart(currentChartType);
            // Luego, renderizar la tabla
            renderTable(data);
            // Actualizar los contadores después de renderizar la tabla
            updateCounters(data);
            // Activar el botón de Franja Horaria por defecto
            document.getElementById('btnFranja').classList.add('active');
            // Actualizar estado de los botones
            updateButtonStates();

            // Inicializar los tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        };

        // **Funciones Añadidas para Importar desde Excel**

        // Referencias a los nuevos elementos
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcelInput');

        // Evento para activar el input de archivo cuando se haga clic en el botón de importar
        importExcelBtn.addEventListener('click', () => {
            importExcelInput.click();
        });

        // Evento para manejar la selección del archivo
        importExcelInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataBuffer = e.target.result;
                const dataView = new Uint8Array(dataBuffer);
                const workbook = XLSX.read(dataView, {type: 'array', raw: false, cellDates: false});
                
                // Asumimos que los datos están en la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: "", raw: false, cellDates: false});
                
                // Procesar los datos
                importDataFromExcel(jsonData);
            };
            reader.onerror = function(ex) {
                console.error(ex);
                alert('Hubo un error al leer el archivo.');
            };
            reader.readAsArrayBuffer(file);

            // Resetear el input para permitir subir el mismo archivo nuevamente si es necesario
            importExcelInput.value = '';
        });

        // Función para importar datos desde Excel
        function importDataFromExcel(jsonData) {
            if (jsonData.length === 0) {
                alert('El archivo Excel está vacío o no contiene datos válidos.');
                return;
            }

            // Definir los nombres de las columnas esperadas
            const expectedColumns = ["Nombre del residente", "Fecha", "Franja horaria", "Lugar", "Consecuencias", "Sensor de Movimiento"];

            // Verificar que todas las columnas esperadas existan
            const fileColumns = Object.keys(jsonData[0]);
            const missingColumns = expectedColumns.filter(col => !fileColumns.includes(col));

            if (missingColumns.length > 0) {
                alert(`Faltan las siguientes columnas en el archivo Excel: ${missingColumns.join(", ")}`);
                return;
            }

            let recordsAdded = 0;
            let recordsSkipped = 0;
            let errorMessages = [];

            jsonData.forEach((row, index) => {
                try {
                    // Extraer y mapear los datos
                    let residente = row["Nombre del residente"].toString().trim();
                    let fechaOriginal = row["Fecha"].toString().trim();
                    let franja = row["Franja horaria"].toString().trim();
                    let lugar = row["Lugar"].toString().trim();
                    let consecuencias = row["Consecuencias"].toString().trim();
                    let sensor = row["Sensor de Movimiento"].toString().trim();

                    // Validar que los campos obligatorios no estén vacíos
                    if (!residente || !fechaOriginal || !franja || !lugar || !consecuencias || !sensor) {
                        recordsSkipped++;
                        errorMessages.push(`Fila ${index + 2}: Campos obligatorios faltantes.`);
                        return;
                    }

                    // Normalizar el nombre del residente
                    residente = residente.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\b\w/g, c => c.toUpperCase());

                    // Validar y formatear la fecha
                    const fechaFormateada = parseFecha(fechaOriginal);
                    if (!fechaFormateada) {
                        recordsSkipped++;
                        errorMessages.push(`Fila ${index + 2}: Fecha inválida.`);
                        return;
                    }

                    // Evitar duplicados (opcional)
                    const duplicate = data.find(item => item.residente === residente && item.fecha === fechaFormateada && item.franja === franja && item.lugar === lugar);
                    if (duplicate) {
                        recordsSkipped++;
                        errorMessages.push(`Fila ${index + 2}: Registro duplicado.`);
                        return;
                    }

                    // Crear nuevo registro con un ID único
                    const nuevoRegistro = {
                        id: generateUniqueId(),
                        residente: residente,
                        fecha: fechaFormateada,
                        franja: franja,
                        lugar: lugar,
                        consecuencias: consecuencias,
                        sensor: sensor
                    };

                    // Agregar al array de datos
                    data.push(nuevoRegistro);

                    // Registrar la acción para deshacer
                    actionStack.push({ action: 'add', record: nuevoRegistro });

                    recordsAdded++;
                } catch (error) {
                    recordsSkipped++;
                    errorMessages.push(`Fila ${index + 2}: Error al procesar el registro.`);
                    console.error(`Error en la fila ${index + 2}:`, error);
                }
            });

            // Actualizar filtros de residente si se han añadido nuevos residentes
            actualizarFiltrosResidentes();

            // Re-renderizar tabla y gráfico
            filterData(); // Filtra y renderiza la tabla con los datos actualizados
            updateChart();

            // Actualizar estado de los botones
            updateButtonStates();

            // Mostrar mensaje de resumen
            let message = `Importación completada.\nRegistros añadidos: ${recordsAdded}\nRegistros omitidos: ${recordsSkipped}`;
            if (errorMessages.length > 0) {
                message += `\n\nErrores:\n${errorMessages.join("\n")}`;
            }
            alert(message);
        }

        // Función para actualizar los filtros de residentes después de la importación
        function actualizarFiltrosResidentes() {
            const uniqueResidentes = [...new Set(data.map(d => d.residente))].sort();
            // Limpiar el select
            filterResidenteSelect.innerHTML = `<option value="">Todos</option>`;
            uniqueResidentes.forEach(r => {
                filterResidenteSelect.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

    </script>

<script>
    const API_URL = "https://sheetdb.io/api/v1/oawmv4fq268tr";

    // Obtener datos desde la API y renderizarlos en la tabla
    function fetchAndRenderData() {
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                renderTable(data);
            })
            .catch(error => {
                console.error("Error al obtener datos:", error);
                alert("No se pudieron cargar los datos.");
            });
    }

    // Agregar un nuevo registro usando la API
    function addRecord(record) {
        fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(record)
        })
        .then(response => response.json())
        .then(data => {
            alert("Registro agregado exitosamente.");
            fetchAndRenderData();
        })
        .catch(error => {
            console.error("Error al agregar el registro:", error);
            alert("No se pudo agregar el registro.");
        });
    }

    // Eliminar un registro por su nombre (único en este caso)
    function deleteRecordByName(name) {
        fetch(`${API_URL}/Nombre del residente/${encodeURIComponent(name)}`, {
            method: "DELETE"
        })
        .then(response => response.json())
        .then(data => {
            alert("Registro eliminado exitosamente.");
            fetchAndRenderData();
        })
        .catch(error => {
            console.error("Error al eliminar el registro:", error);
            alert("No se pudo eliminar el registro.");
        });
    }

    // Renderizar los datos en la tabla
    function renderTable(data) {
        const tbody = document.querySelector("#data-table tbody");
        tbody.innerHTML = ""; // Limpiar la tabla

        data.forEach(item => {
            const row = `
                <tr>
                    <td>${item["Nombre del residente"]}</td>
                    <td>${item["Fecha"]}</td>
                    <td>${item["Franja horaria"]}</td>
                    <td>${item["Lugar"]}</td>
                    <td>${item["Consecuencias"]}</td>
                    <td>${item["Sensor de movimiento"]}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteRecordByName('${item["Nombre del residente"]}')">Eliminar</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Manejar el envío del formulario para agregar un nuevo registro
    document.getElementById("registroCaidas").addEventListener("submit", function(event) {
        event.preventDefault();

        const nuevoRegistro = {
            "Nombre del residente": document.getElementById("nombreResidente").value,
            "Fecha": document.getElementById("fechaCaida").value,
            "Franja horaria": document.getElementById("franjaHoraria").value,
            "Lugar": document.getElementById("lugarCaida").value,
            "Consecuencias": document.getElementById("consecuencias").value,
            "Sensor de movimiento": document.getElementById("sensorMovimiento").value
        };

        addRecord(nuevoRegistro);
        this.reset(); // Resetear el formulario
    });

    // Cargar datos al inicio
    window.onload = fetchAndRenderData;
</script>

</body>
</html>
